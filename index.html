<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Extractor de columnas PDF</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      padding: 2rem;
      color: #333;
    }
    h2 {
      text-align: center;
    }
    .uploader {
      border: 2px dashed #3b82f6;
      border-radius: 12px;
      background: #e0f2fe;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .uploader input[type="file"] {
      display: none;
    }
    .uploader label {
      display: inline-block;
      padding: 0.5rem 1rem;
      background-color: #3b82f6;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    .section {
      margin-bottom: 1.5rem;
    }
    input, textarea {
      padding: 0.5rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      margin-top: 0.5rem;
    }
    button {
      padding: 0.75rem 1.5rem;
      background-color: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .referencias-box {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    .referencias-box span {
      background-color: #facc15;
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }
    .exclusiones-list {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      margin-top: 0.25rem;
    }
    .exclusiones-list span {
      background-color: #ef4444;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 6px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <h2>Extractor de columnas desde PDF</h2>

  <div class="uploader">
    <label for="fileInput">Seleccionar PDF</label>
    <input type="file" id="fileInput">
  </div>

  <div class="section">
    <label for="numColumnas">¿Cuántas columnas deseas extraer?</label>
    <input type="number" id="numColumnas" min="1" max="10" value="1">
    <button onclick="generarInputs()">Generar campos</button>
  </div>

  <div class="section" id="inputsContainer"></div>

  <div class="section">
    <label>Palabras clave sugeridas:</label>
    <div class="referencias-box" id="sugerencias">
      <span onclick="agregarReferencia('Resultados Búsqueda')">Resultados Búsqueda</span>
      <span onclick="agregarReferencia('Situación Admva.')">Situación Admva.</span>
      <span onclick="agregarReferencia('Nombre/Razón Social')">Nombre/Razón Social</span>
      <span onclick="agregarReferencia('NIF/CIF')">NIF/CIF</span>
    </div>
  </div>

  <button onclick="subir()">Procesar PDF</button>
  <p id="estado"></p>

  <script>
    function generarInputs() {
      const container = document.getElementById("inputsContainer");
      container.innerHTML = "";
      const num = parseInt(document.getElementById("numColumnas").value);
      for (let i = 0; i < num; i++) {
        const div = document.createElement("div");

        const label = document.createElement("label");
        label.textContent = `Columna ${i + 1}`;
        div.appendChild(label);

        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = `Referencia columna ${i + 1}`;
        input.className = "referencia";
        input.required = true;
        div.appendChild(input);

        const exclLabel = document.createElement("label");
        exclLabel.textContent = "Valores a excluir (uno por uno, presiona Enter):";
        div.appendChild(exclLabel);

        const exclInput = document.createElement("input");
        exclInput.type = "text";
        exclInput.placeholder = "Escribe un valor y presiona Enter";
        exclInput.className = "exclusion";
        exclInput.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            if (exclInput.value.trim()) {
              const span = document.createElement("span");
              span.textContent = exclInput.value.trim();
              exclList.appendChild(span);
              exclInput.value = "";
            }
          }
        });
        div.appendChild(exclInput);

        const exclList = document.createElement("div");
        exclList.className = "exclusiones-list";
        div.appendChild(exclList);

        container.appendChild(div);
        container.appendChild(document.createElement("hr"));
      }
    }

    function agregarReferencia(valor) {
      const inputs = document.querySelectorAll("input.referencia");
      for (let i = 0; i < inputs.length; i++) {
        if (!inputs[i].value) {
          inputs[i].value = valor;
          return;
        }
      }
    }

    async function subir() {
      const file = document.getElementById('fileInput').files[0];
      const referencias = [...document.querySelectorAll("input.referencia")].map(el => el.value.trim()).filter(Boolean);
      const exclusiones = [...document.querySelectorAll(".exclusiones-list")].map(list =>
        [...list.children].map(span => span.textContent)
      );

      if (!file || referencias.length === 0) return alert("Selecciona un archivo y completa las referencias.");

      const formData = new FormData();
      formData.append("file", file);
      formData.append("referencias", JSON.stringify(referencias));
      formData.append("exclusiones", JSON.stringify(exclusiones));

      document.getElementById("estado").innerText = "Procesando...";

      try {
        const response = await fetch("https://tablas-pdf.onrender.com/procesar/", {
          method: "POST",
          body: formData
        });

        if (response.ok) {
          const blob = await response.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "resultado.xlsx";
          a.click();
          document.getElementById("estado").innerText = "¡Procesado con éxito!";
        } else {
          document.getElementById("estado").innerText = "Error al procesar.";
        }
      } catch (e) {
        document.getElementById("estado").innerText = "Error de conexión.";
        console.error(e);
      }
    }
  </script>
</body>
</html>
